<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />
    <title>Document</title>
    <style>
      body,
      html {
        margin: 0px;
        padding: 0px;
      }
      body {
        min-width: 100%;
        min-height: 100vh;
        background-image: linear-gradient(
            rgba(0, 0, 0, 0.5),
            rgba(0, 0, 0, 0.5)
          ),
          url("https://images.unsplash.com/photo-1486312338219-ce68d2c6f44d?ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&ixlib=rb-1.2.1&auto=format&fit=crop&w=752&q=80");
        background-repeat: no-repeat;
        background-size: cover;
        background-attachment: fixed;
      }
      h1 {
        color: white;
        text-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
      }

      .login {
        width: 150px;
        font-style: italic;
        background-color: transparent;
        border-radius: 0;
        border: 2px solid white;
        color: white;
      }
      .login:hover {
        color: black;
        background-color: white;
        outline: none;
        border: 2px solid white;
      }
      .login:focus {
        border: 2px solid white;
        outline: none;
      }
      .send {
        border-radius: 0;
        width: 150px;
      }
    </style>
  </head>
  <body>
    <h1 class="text-center mt-4">Vamos a probar</h1>
    <div class="text-center mt-5">
      <button class="btn btn-default login">Acceder</button>
    </div>
    <div class="visible code row p-5 justify-content-center text-center" style="position: absolute;">
      <div class="col-6">
        <div class="card">
          <div class="card-body">
            <form>
              <div class="mb-3">
                <label for="codigo" class="form-label mb-3">Código</label>
                <input
                  type="text"
                  class="form-control"
                  id="codigo"
                  name="codigo"
                  placeholder="Ingrese el codigo dado en la url de ML."
                />
              </div>
              <div class="text-center pt-3">
                <button class="btn-outline-primary btn sendCode">Enviar</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    <div class="invisible search row p-5 justify-content-center text-center" style="position: absolute; width: 100%;">
      <div class="col-6">
        <div class="card">
          <div class="card-body">
            <form>
              <div class="mb-3">
                <label for="busqueda" class="form-label mb-3">Búsqueda</label>
                <input
                  type="text"
                  class="form-control"
                  id="busqueda"
                  placeholder="Ingrese la busqueda del producto que desea monitorear"
                />
              </div>
              <div class="text-center pt-3">
                <button class="btn-outline-primary btn sendQ">
                  Buscar Producto
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
      <div class="text-center">
        <button class="show btn btn-primary">Mostrar tabla</button>
      </div>
    </div>
    <div class="row justify-content-center" style="position: absolute; width: 100%; top: 65%;">
      <div class="col-6">
        <table class="table table-light">
          <thead>
            <tr>
              <th scope="col">#</th>
              <th scope="col">Titulo</th>
              <th scope="col">Precio</th>
              <th scope="col">Compra</th>
            </tr>
          </thead>
          <tbody id="cuerpo">
            <tr>
              <th></th>
              <th></th>
              <th></th>
              <th></th>
            </tr>
          </tbody>
        </table>        
      </div>
    </div>
    <script>
      var client_id = "880976774391862";
      var client_secret = "qCsOgLKXPHnieNz0K5ROACIQZs7wH1qC";
      var redirect_uri = "https://mercadolb.herokuapp.com/";
      var code, q;
      var list = [];

      var user = JSON.parse(localStorage.getItem("dataUser")) || {
        id_user: null,
        token: null,
      };

      if (user.access_token || user.user_id) {
        document.querySelector(".code").className =
          "invisible code row p-5 justify-content-center text-center";
        document.querySelector(".search").className =
          "visible search row p-5 justify-content-center text-center";
      }

      document.querySelector(".login").addEventListener("click", (e) => {
        e.preventDefault();
        window.open(
          `http://auth.mercadolibre.com.co/authorization?response_type=code&client_id=${client_id}&redirect_uri=${redirect_uri}`,
          "_blank"
        );
      });

      document.querySelector(".sendCode").addEventListener("click", async (e) => {
          e.preventDefault();
          code = document.getElementById("codigo").value;
          document.querySelector(".code").className =
            "invisible code row p-5 justify-content-center text-center";

          await fetch("https://api.mercadolibre.com/oauth/token", {
            body: `grant_type=authorization_code&client_id=${client_id}&client_secret=${client_secret}&code=${code}&redirect_uri=${redirect_uri}`,
            headers: {
              Accept: "application/json",
              "Content-Type": "application/x-www-form-urlencoded",
            },
            method: "POST",
          })
            .then((response) => {
              return response.json();
            })
            .then((data) => {
              console.log(data);
              localStorage.setItem(
                "dataUser",
                JSON.stringify({
                  access_token: data.access_token,
                  user_id: data.user_id,
                })
              );
              document.querySelector(".search").className =
                "visible search row p-5 justify-content-center text-center";
            })
            .catch((error) => {
              console.log(error);
            });
        });

      document.querySelector(".sendQ").addEventListener("click", async (e) => {
        e.preventDefault();
        q = document.getElementById("busqueda").value;
        await fetch(
          `https://api.mercadolibre.com/sites/MCO/search?q=${q}&sort=price_asc`,
          {
            headers: {
              Authorization: `Bearer $${user.access_token}`,
            },
          }
        )
          .then((response) => {
            return response.json();
          })
          .then((data) => {
            data.results.filter((e) => {
              best_seller(e.seller.id, e);
            });
//            orderByPrice(list);
//            paintTable(list);
//              console.log(list)
          });
      });

      async function best_seller(seller_id, element) {
        await fetch(`https://api.mercadolibre.com/users/${seller_id}`, {
          headers: {
            Authorization: `Bearer $${user.access_token}`,
          },
        })
        .then((response) => {
          return response.json();
        })
        .then((data) => {
          if (data.seller_reputation.level_id == "5_green") {
            list.push(element);
          }
          return list;
        });
      }

      document.querySelector('.show').addEventListener('click', (e)=>{
        e.preventDefault();
        orderByPrice(list);
        paintTable(list);
      })

      function orderByPrice(array){
        array.sort(function (a, b){
          if (a.price < b.price)
            return -1;
          if ( a.price > b.price )
            return 1;
          return 0;
        })
      }

      function paintTable(array){
        for(let element of array){
          document.querySelector('#cuerpo').innerHTML +=`
              <tr>
                <th scope="row">${element.id}</th>
                <td>${element.title}</td>
                <td>$${new Intl.NumberFormat().format(element.price)}</td>
                <td><a class="btn btn-primary" target="_blank" href="${element.permalink}">Comprar</td>
              </tr>
          `
        }
      }
    </script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
